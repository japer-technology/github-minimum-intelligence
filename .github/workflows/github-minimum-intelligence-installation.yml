name: github-minimum-intelligence-installation

on:
  installation:
    types: [created]
  installation_repositories:
    types: [added]

permissions:
  contents: read

jobs:
  welcome:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Log installation
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          echo "GitHub Minimum Intelligence installed."
          echo "Installation ID: ${{ github.event.installation.id }}"
          echo "Installed by: ${{ github.event.installation.account.login }}"

      - name: Post welcome issue to new repos
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Determine which repos were just added
          if [ "${{ github.event_name }}" = "installation" ]; then
            REPOS=$(echo '${{ toJSON(github.event.repositories) }}' | jq -r '.[].full_name // empty' 2>/dev/null || true)
          else
            REPOS=$(echo '${{ toJSON(github.event.repositories_added) }}' | jq -r '.[].full_name // empty' 2>/dev/null || true)
          fi

          for REPO in $REPOS; do
            echo "Creating welcome issue in $REPO"
            gh issue create --repo "$REPO" \
              --title "üß† Welcome to Minimum Intelligence" \
              --body "$(cat <<'EOF'
          ## Minimum Intelligence is installed! üéâ

          Your repository now has an AI agent that responds to issues. Here's what to do next:

          ### 1. Add the agent files

          The GitHub App handles authentication, but you still need the agent code in this repo.
          From the root of this repository, run:

          ```bash
          curl -fsSL https://raw.githubusercontent.com/japer-technology/github-minimum-intelligence/main/setup.sh | bash
          ```

          Or manually copy the `.github-minimum-intelligence/` folder from
          [github-minimum-intelligence](https://github.com/japer-technology/github-minimum-intelligence).

          ### 2. Add your LLM API key

          Go to **Settings ‚Üí Secrets and variables ‚Üí Actions** and add a secret for your AI provider
          (e.g. `ANTHROPIC_API_KEY`). See the [supported providers list](https://github.com/japer-technology/github-minimum-intelligence#supported-providers).

          ### 3. Start chatting

          Open a new issue and write anything ‚Äî the agent will pick it up and reply.

          ---
          _This issue was created automatically by the Minimum Intelligence GitHub App._
          EOF
          )" 2>/dev/null || echo "  ‚ö†Ô∏è Could not create issue in $REPO (may lack issues permission)"
          done
